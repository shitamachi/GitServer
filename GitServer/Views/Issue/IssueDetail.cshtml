@* @model GitServer.ViewModel.IssueViewModel *@
@* @using GitServer.ApplicationCore.Models *@
@using GitServer.Extensions
@using GitServer.ViewModel
@model Tuple<GitServer.ApplicationCore.Models.Issue, List<GitServer.ApplicationCore.Models.Comment>>

@{
    ViewBag.Title = "title";
    Layout = "_Layout";

    var currUser = (string) ViewContext.RouteData.Values["userName"];
    var currRepo = (string) ViewContext.RouteData.Values["repoName"];
    var issue = Model.Item1;
    var comments = Model.Item2.OrderBy(comment => comment.CreationDate);
}

<h1 class="ui header">
    @issue.Title #@issue.Index
    <div class="sub header">@(issue.IsClosed ? "closed" : "open") @issue.UserName opend this issue on @issue.CreationDate · @(!comments.Any() ? "no comment" : $"{comments.Count()} comment")</div>
</h1>
<div class="ui comments">
    <h3 class="ui dividing header">Comments</h3>
    <div class="comment">
        <div class="content">
            <a class="author">@issue.UserName</a>
            <div class="metadata">
                <span class="date">@issue.CreationDate.ToLongDateString()</span>
            </div>
            <div class="text">
                <p>@issue.Content</p>
            </div>
            <div class="actions">
                <a class="reply">Reply</a>
            </div>
        </div>
    </div>
    @foreach (var comment in comments)
    {
        <div class="comment">
            <div class="content">
                <a class="author">@comment.UserName</a>
                <div class="metadata">
                    <span class="date">@comment.CreationDate.ToLongDateString()</span>
                </div>
                <div class="text">
                    <p>@comment.Content</p>
                </div>
                <div class="actions">
                    <a class="reply">Reply</a>
                </div>
            </div>
        </div>
    }
    <form class="ui reply form" action="/@currUser/@currRepo/issue/@issue.Index.ToString()" method="post">
        <div class="field">
            <textarea id="reply-field" name="content"></textarea>
        </div>
        <input id="reply-user" name="replyUser" hidden="hidden" value=""/>
        <button class="ui blue labeled submit icon button" type="submit">
            <i class="icon edit"></i> Add Reply
        </button>
    </form>
</div>

<script>
    let actions = $(".comment > .content > .actions")
    
    for(let i = 0; i < actions.length; i++) {
        let author = $(actions[i]).siblings(".author")
        actions[i].addEventListener("click", e => {
            e.preventDefault()
            $("#reply-field").val((index, value) => {
                return value + `@@${author.text()} `
            })
            $("#reply-user").val(author.text())
            $("#reply-field").focus()
            $(actions[i]).attr("disabled", true)
        })
      $(actions[i]).siblings(".author")
    }
</script>